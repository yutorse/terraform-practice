# Chapter2

Q: `variable`ブロックで `default` に指定した値を参照するときに、プロパティアクセスをしなくてもいい理由は？

```
var.example_instance_type の参照は 常に可能
Terraform の変数は 必ず定義されている とみなされます

値がどこから来るかは次の優先順位で決まります:

1. CLI の -var オプション

2. .tfvars ファイルや terraform.tfvars

3. 環境変数（TF_VAR_変数名）

4. variable ブロックの default

5. どこにも値が無い場合 → apply 時にプロンプトで入力を求められる
```

Q: プロパティへのアクセス方法は？

```
リソースの参照ルール
Terraform では次の形で参照します。

<種類またはブロックタイプ>.<ローカル識別子>.<属性>
例:
- 変数: var.example_instance_type
- ローカル値: local.example_instance_type
- データソース: data.aws_ami.latest.id
- モジュール出力: module.web_server.instance_id
```

Q: terraform 本体とプロバイダの関係は？

```
あなたの.tfコード
    ↓
Terraform本体
    - HCLを解析
    - 差分を計算
    - "EC2を作れ"という命令を生成
    ↓
AWSプロバイダ
    - AWSのEC2 APIを呼び出す
    - レスポンスを受け取ってTerraform本体に返す
    ↓
Terraform本体
    - stateファイルに新しいリソースIDや状態を書き込む
```

Q: `file()`で呼び出すファイルのパスは、module 基準か、module 呼び出し元基準か？

呼び出し元の tf ファイルがあるパスを基準に解決される

Q: VPC と VPN の違いがあまりわかっていない

![](./images/スクリーンショット%202025-08-12%202.14.12.png)

Q. インターネットゲートウェイとは？

```
インターネットゲートウェイ（IGW）とは？
AWSのVPCとインターネットを接続するためのゲート（出口）。

これが無いと、パブリックIPを持っていてもインターネットにアクセスできない。

IGWは冗長構成（AWS側で自動的に冗長化）されており、特定のAZに依存しない。
```

Q. ルートテーブルとは？

```
ルートテーブルとは？
通信経路の地図 のようなもの。

「このIP宛の通信はどこへ送るか」を決める設定。

AWSでは、VPC作成時にメインルートテーブルが自動で作られるが、必要に応じて追加で作れる。

作成直後は、そのVPC内のローカル通信ルートだけを持っている（例: 10.0.0.0/16 → local）。
```

Q. EIP(Elastic IP) の役割は？

```
NATゲートウェイは、プライベートサブネットのインスタンスがインターネットへアクセスするときに送信元アドレスをこのEIPに変換して通信します。

これにより、外部のサービスからは「この固定IPからのアクセス」として見える。

IPが固定になることで、ファイアウォールやAPI制限がある外部サービスでもアクセスを許可しやすくなる。
```

Q. NAT ゲートウェイの役割は？

```
プライベートサブネット内のインスタンスが直接パブリックIPを持たずにインターネットにアクセスできるようにする。

外部からプライベートサブネット内に直接アクセスはできないため、セキュリティが高い。

NATゲートウェイを使うことでOSのアップデートや外部APIアクセスが可能になる。
```

Q. パブリックなサブネットに置かれている NAT ゲートウェイをどのように通して、外へ通信する？

```
NATゲートウェイとサブネット間の通信の流れ
プライベートサブネットのEC2インスタンスが外部に通信しようとする
　- インスタンスのルートテーブルに「0.0.0.0/0 → NATゲートウェイ」のルートが設定されている。

プライベートサブネットからのパケットはルートに従い、NATゲートウェイがあるパブリックサブネットへ送られる
　- ここで重要なのは、VPC内のネットワークはAZ内外問わず自由に通信できる点です。
　- つまりプライベートサブネットからパブリックサブネットへのルーティングはVPC内の内部通信として処理されます。

NATゲートウェイがプライベートIPアドレスを自分のパブリックIP（Elastic IP）に変換してインターネットへ通信を中継
　- 外部からはNATゲートウェイの固定IPでアクセスされる。
```

Q. ALB から EC2 や ECS への振り分け方は？

```
ALBは直接EC2やECSを指定するのではなく、ターゲットグループを経由します。

ターゲットグループのターゲットとして、以下を登録できます：

EC2インスタンス（インスタンスID）

特定のIPアドレス

ECSサービス（Fargateも含む）

Lambda関数（HTTP APIとして）

ALB → ターゲットグループ → EC2/ECS という流れ。
```

Q. ホストゾーン, NS レコード, SOA レコードとは？

```
1. ホストゾーン（Hosted Zone）
ドメインのDNS設定を管理する入れ物

例：example.com のホストゾーンを作ると、その中にAレコードやCNAMEレコードなどを定義できる

Route 53では2種類：

パブリックホストゾーン
インターネット全体から参照されるDNS設定（例：example.com を世界に公開）

プライベートホストゾーン
特定のVPC内だけで使えるDNS設定（例：社内専用のinternal.example.com）

2. NSレコード（Name Server Record）
「このドメインのDNSはどのネームサーバが管理しているか」を教えるレコード

ドメイン登録時、レジストラにNSレコードを登録することで、「問い合わせ先」が決まる

例（example.com の場合）：

example.com.  172800  IN  NS  ns-123.awsdns-45.com.
example.com.  172800  IN  NS  ns-678.awsdns-90.net.
example.com.  172800  IN  NS  ns-234.awsdns-56.org.
example.com.  172800  IN  NS  ns-345.awsdns-78.co.uk.
Route 53でホストゾーンを作ると、最初からこのNSレコードが自動生成される
→ この情報をレジストラ（お名前.comやGoogle Domains等）に登録すれば、そのホストゾーンがインターネットの正しい権威サーバになる

3. SOAレコード（Start of Authority Record）
そのゾーンの「公式情報（権威）」を示すレコード

通常はゾーンごとに1つだけ存在

含まれる情報：

ゾーンを管理するマスターDNSサーバ名

管理者メールアドレス（@ が . に置き換えられた形式）

シリアル番号（ゾーンの更新番号）

キャッシュ有効期限や再試行間隔などのパラメータ
```

Q. A レコード, CNAME レコード, ALIAS レコードとは？

```
1. Aレコード
ホスト名 → IPv4アドレス を直接対応づけるレコード

例：
example.com.  300  IN  A  192.0.2.1
特徴：

常にIPアドレスを直接持つ

ルートドメイン（example.com）にも設定できる

AWSリソース（ALBなど）には直接使えない場合がある（ALBのIPは固定じゃないため）

2. CNAMEレコード
ホスト名 → 別のホスト名 を対応づけるレコード

例：
www.example.com.  300  IN  CNAME  example.com.
→ www.example.com にアクセスすると、まず example.com のIPをDNSで調べる

特徴：

IPを持たず、必ず別のドメイン名にリダイレクト（DNSレベル）する

ルートドメイン（example.com）には設定できない（DNS仕様上の制限）

AWSのALBやCloudFrontのDNS名に向けるときに使える

ただし、名前解決が2段階になるため若干遅延の可能性あり

3. ALIASレコード（Route 53独自機能）
Aレコードのように見えて、実はAWSリソースへのポインタ

例（Terraformで書くとこうなる）：
type = "A"
alias {
  name    = aws_lb.example.dns_name
  zone_id = aws_lb.example.zone_id
}
特徴：

Route 53が裏でリソースのIPアドレスを動的に解決して返す

ルートドメインにも設定可能

AWSリソース（ALB, CloudFront, S3静的サイト, API Gatewayなど）と直接紐づけ可能

通常のAレコードのように見えるが、IPが変わっても自動追従

名前解決は1回で済む（CNAMEより高速）
```

Q. SSL/TLS 通信の流れは？

```
SSL証明書があると通信はどう暗号化されるのか？
1. 公開鍵と秘密鍵のペア
証明書は 公開鍵 を含む電子文書です。

サーバー（例：Webサーバー）は、証明書に対応する 秘密鍵 を安全に保管しています。

2. 通信開始（TLSハンドシェイク）
クライアント（ブラウザ）がサーバーに接続要求を送る

サーバーは証明書（公開鍵を含む）をクライアントに送る

クライアントは証明書の有効性をCA（認証局）に確認し、信用できるか検証する

3. 鍵の共有（セッション鍵の生成）
クライアントは「この通信で使う共通の秘密鍵（セッション鍵）」を作成

そのセッション鍵を サーバーの公開鍵で暗号化 してサーバーに送る

サーバーは秘密鍵でそのセッション鍵を復号

4. 通信の暗号化開始
クライアントとサーバーはこの「共通のセッション鍵」を使って

その後の通信（HTTPリクエストとレスポンス）を高速な共通鍵暗号で暗号化してやりとりする

これにより通信内容の盗聴・改ざんを防止

なぜ証明書が必要？
公開鍵暗号は安全だけど遅いため、実際の通信は共通鍵暗号で行う

そこで「共通鍵」を安全に共有するために証明書（公開鍵）を使う

証明書がなければ、偽のサーバーに鍵を盗まれたり、なりすましされるリスクが高い
```

Q. DNS 検証の仕組みは？

```
DNS検証の仕組み
証明書リクエスト時にAWSが「検証用レコード」を生成

ACMがあなたのドメインの所有を確認するために特別なDNSレコード（通常はCNAME）を用意します。

このレコードはランダムなトークンのようなもので、ACMが所有権を判別するキーとなります。

ユーザー（Terraformなど）側がDNSに検証用レコードを登録

Terraformのコードにあるように、aws_route53_record リソースでこの特別なCNAMEレコードをRoute53に登録します。

例：

objectivec
コピーする
編集する
_xxxxxx.example.com CNAME _yyyyyy.acm-validations.aws.
AWSが定期的にDNSをチェック

ACMはこのDNSレコードを定期的にDNSサーバーに問い合わせます。

登録したCNAMEレコードが正しく設定されていると確認できれば、そのドメインはあなたが管理していると判断します。

検証完了で証明書を発行

DNS検証が成功すると、ACMは証明書発行を完了します。
```

Q. ALB を置いたときのターゲットである EC2 は HTTPS 対応していなくても良い？

```
1. ALBでTLS終端（SSL終端）を行うケース
ALBが外部クライアントとの通信をHTTPSで受ける（インターネット側は安全な通信）

そのあと、ALBからターゲット（EC2）へは HTTP（暗号化なし）で通信する構成がよく使われます。

2. なぜHTTPで良いのか？
ALBとターゲットは 同じVPC内やプライベートネットワーク内にいることが多いため、
通信経路が比較的安全と見なされます。

そのため、ALBがHTTPS通信を終端して復号化し、ターゲットにはHTTPでリクエストを送るのがシンプルで負荷も少ない。
```

Q. arn を指定するときと id を指定するときの違いは？
